define(["moment","jquery","app/core/app_events","lodash","app/plugins/sdk","app/core/utils/kbn"],function(t,e,n,i,o,s){return function(t){var e={};function n(i){if(e[i])return e[i].exports;var o=e[i]={i:i,l:!1,exports:{}};return t[i].call(o.exports,o,o.exports,n),o.l=!0,o.exports}return n.m=t,n.c=e,n.d=function(t,e,i){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var o in t)n.d(i,o,function(e){return t[e]}.bind(null,o));return i},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="",n(n.s=4)}([function(e,n){e.exports=t},function(t,n){t.exports=e},function(t,e){t.exports=n},function(t,e){t.exports=i},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.PanelCtrl=void 0;var i=n(5),o=n(7),s=u(n(3)),a=u(n(1)),r=u(n(0)),l=u(n(8)),h=u(n(2));function u(t){return t&&t.__esModule?t:{default:t}}var d=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(e,n)};return function(e,n){function i(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),p=["#7EB26D","#EAB839","#6ED0E0","#EF843C","#E24D42","#1F78C1","#BA43A9","#705DA0","#508642","#CCA300","#447EBC","#C15C17","#890F02","#0A437C","#6D1F62","#584477","#B7DBAB","#F4D598","#70DBED","#F9BA8F","#F29191","#82B5D8","#E5A8E2","#AEA2E0","#629E51","#E5AC0E","#64B0C8","#E0752D","#BF1B00","#0A50A1","#962D82","#614D93","#9AC48A","#F2C96D","#65C5DB","#F9934E","#EA6460","#5195CE","#D683CE","#806EB7","#3F6833","#967302","#2F575E","#99440A","#58140C","#052B51","#511749","#3F2B5B","#E0F9D7","#FCEACA","#CFFAFF","#F9E2D2","#FCE2DE","#BADFF4","#F9D9F9","#DEDAF7"],c=function(t){function e(e,n,i){var o=t.call(this,e,n)||this;return o.annotationsSrv=i,o.defaults={display:"timeline",rowHeight:50,valueMaps:[{value:"null",op:"=",text:"N/A"}],rangeMaps:[{from:"null",to:"null",text:"N/A"}],colorMaps:[{text:"N/A",color:"#CCC"}],metricNameColor:"#000000",valueTextColor:"#000000",timeTextColor:"#d8d9da",crosshairColor:"#8F070C",backgroundColor:"rgba(128,128,128,0.1)",lineColor:"rgba(0,0,0,0.1)",textSize:24,textSizeTime:12,extendLastValue:!0,writeLastValue:!0,writeAllValues:!1,writeMetricNames:!1,showTimeAxis:!0,showLegend:!0,showLegendNames:!0,showLegendValues:!0,showLegendPercent:!0,highlightOnMouseover:!0,expandFromQueryS:0,legendSortBy:"-ms",units:"short"},o.annotations=[],o.data=null,o.legend=null,o.externalPT=!1,o.isTimeline=!0,o.isStacked=!1,o.hoverPoint=null,o.colorMap={},o.unitFormats=null,o.formatter=null,o._colorsPaleteCash=null,o._renderDimensions={},o._selectionMatrix=[],s.default.defaultsDeep(o.panel,o.defaults),o.panel.display="timeline",o.events.on("init-edit-mode",o.onInitEditMode.bind(o)),o.events.on("render",o.onRender.bind(o)),o.events.on("panel-initialized",o.onPanelInitialized.bind(o)),o.events.on("refresh",o.onRefresh.bind(o)),o.events.on("data-received",o.onDataReceived.bind(o)),o.events.on("data-snapshot-load",o.onDataSnapshotLoad.bind(o)),o.events.on("data-error",o.onDataError.bind(o)),o}return d(e,t),e.$inject=["$scope","$injector","annotationsSrv"],e.prototype.onPanelInitialized=function(){this.updateColorInfo(),this.onConfigChanged()},e.prototype.onDataSnapshotLoad=function(t){this.onDataReceived(t)},e.prototype.onDataError=function(t){this.annotations=[],console.log("onDataError",t)},e.prototype.onInitEditMode=function(){this.unitFormats=l.default.getUnitFormats(),this.addEditorTab("Options","public/plugins/natel-discrete-panel/partials/editor.options.html",1),this.addEditorTab("Legend","public/plugins/natel-discrete-panel/partials/editor.legend.html",3),this.addEditorTab("Colors","public/plugins/natel-discrete-panel/partials/editor.colors.html",4),this.addEditorTab("Mappings","public/plugins/natel-discrete-panel/partials/editor.mappings.html",5),this.editorTabIndex=1,this.refresh()},e.prototype.onRender=function(){null!=this.data&&this.context&&(this._updateRenderDimensions(),this._updateSelectionMatrix(),this._updateCanvasSize(),this._renderRects(),this._renderTimeAxis(),this._renderLabels(),this._renderAnnotations(),this._renderSelection(),this._renderCrosshair(),this.renderingCompleted())},e.prototype.showLegandTooltip=function(t,e){var n='<div class="graph-tooltip-time">'+e.val+"</div>";n+="<center>",e.count>1&&(n+=e.count+" times<br/>for<br/>"),n+=r.default.duration(e.ms).humanize(),e.count>1&&(n+="<br/>total"),n+="</center>",this.$tooltip.html(n).place_tt(t.pageX+20,t.pageY)},e.prototype.clearTT=function(){this.$tooltip.detach()},e.prototype.formatValue=function(t){if(s.default.isNumber(t)){if(this.panel.rangeMaps)for(var e=0;e<this.panel.rangeMaps.length;e++){var n=this.panel.rangeMaps[e],i=parseFloat(n.from);if(parseFloat(n.to)>=t&&i<=t)return n.text}this.formatter&&(t=this.formatter(t,this.panel.decimals))}var o=s.default.isNil(t);for(o||s.default.isString(t)||(t=t.toString()),e=0;e<this.panel.valueMaps.length;e++)if("null"!==(n=this.panel.valueMaps[e]).value){if(t===n.value)return n.text}else if(o)return n.text;return o?"null":t},e.prototype.getColor=function(t){if(s.default.has(this.colorMap,t))return this.colorMap[t];if(void 0===this._colorsPaleteCash[t]){var e=p[this._colorsPaleteCash.length%p.length];this._colorsPaleteCash[t]=e,this._colorsPaleteCash.length++}return this._colorsPaleteCash[t]},e.prototype.randomColor=function(){for(var t="ABCDE".split(""),e="#",n=0;n<3;n++)e+=t[Math.floor(Math.random()*t.length)];return e},e.prototype.applyPanelTimeOverrides=function(){if(t.prototype.applyPanelTimeOverrides.call(this),this.panel.expandFromQueryS&&this.panel.expandFromQueryS>0){var e=this.range.from.subtract(this.panel.expandFromQueryS,"s");this.range.from=e,this.range.raw.from=e}},e.prototype.onDataReceived=function(t){var e=this;(0,a.default)(this.canvas).css("cursor","pointer");var n=[];s.default.forEach(t,function(t){if("table"===t.type){if("time"!==t.columns[0].type)throw new Error("Expected a time column from the table format");for(var i=1;i<t.columns.length;i++){for(var a=new o.DistinctPoints(t.columns[i].text),r=0;r<t.rows.length;r++){var l=t.rows[r];a.add(l[0],e.formatValue(l[i]))}a.finish(e),n.push(a)}}else{var h=new o.DistinctPoints(t.target);s.default.forEach(t.datapoints,function(t){h.add(t[1],e.formatValue(t[0]))}),h.finish(e),n.push(h)}}),this.data=n,this.updateLegendMetrics(),this.annotationsSrv.getAnnotations({dashboard:this.dashboard,panel:this.panel,range:this.range}).then(function(t){e.loading=!1,t.annotations&&t.annotations.length>0?e.annotations=t.annotations:e.annotations=null,e.onRender()},function(){e.loading=!1,e.annotations=null,e.onRender(),console.log("ERRR",e)})},e.prototype.updateLegendMetrics=function(t){!this.data||!this.panel.showLegend||this.panel.showLegendNames||this.data.length<=1?this.legend=this.data:this.legend=[o.DistinctPoints.combineLegend(this.data,this)],t&&this.onConfigChanged()},e.prototype.removeColorMap=function(t){var e=s.default.indexOf(this.panel.colorMaps,t);this.panel.colorMaps.splice(e,1),this.updateColorInfo()},e.prototype.updateColorInfo=function(){for(var t={},e=0;e<this.panel.colorMaps.length;e++){var n=this.panel.colorMaps[e];n.text&&(t[n.text]=n.color)}this._colorsPaleteCash={},this._colorsPaleteCash.length=0,this.colorMap=t,this.render()},e.prototype.addColorMap=function(t){var e=this;"curent"===t?s.default.forEach(this.data,function(t){t.legendInfo&&s.default.forEach(t.legendInfo,function(t){if(!s.default.has(e.colorMap,t.val)){var n={text:t.val,color:e.getColor(t.val)};e.panel.colorMaps.push(n),e.colorMap[t.val]=n}})}):this.panel.colorMaps.push({text:"???",color:this.randomColor()}),this.updateColorInfo()},e.prototype.removeValueMap=function(t){var e=s.default.indexOf(this.panel.valueMaps,t);this.panel.valueMaps.splice(e,1),this.render()},e.prototype.addValueMap=function(){this.panel.valueMaps.push({value:"",op:"=",text:""})},e.prototype.removeRangeMap=function(t){var e=s.default.indexOf(this.panel.rangeMaps,t);this.panel.rangeMaps.splice(e,1),this.render()},e.prototype.addRangeMap=function(){this.panel.rangeMaps.push({from:"",to:"",text:""})},e.prototype.onConfigChanged=function(t){void 0===t&&(t=!1),this.isTimeline="timeline"===this.panel.display,this.isStacked="stacked"===this.panel.display,this.formatter=null,this.panel.units&&"none"!==this.panel.units&&(this.formatter=l.default.valueFormats[this.panel.units]),t?this.refresh():this.render()},e.prototype.getLegendDisplay=function(t,e){var n=t.val;if(this.panel.showLegendPercent||this.panel.showLegendCounts||this.panel.showLegendTime){n+=" (";var i=!1;if(this.panel.showLegendTime&&(n+=r.default.duration(t.ms).humanize(),i=!0),this.panel.showLegendPercent){i&&(n+=", ");var o=this.panel.legendPercentDecimals;s.default.isNil(o)&&(o=t.per>.98&&e.changes.length>1?2:t.per<.02?2:0),n+=l.default.valueFormats.percentunit(t.per,o),i=!0}this.panel.showLegendCounts&&(i&&(n+=", "),n+=t.count+"x"),n+=")"}return n},e.prototype.showTooltip=function(t,e,n){var i=e.start,o=e.start+e.ms,s=e.ms,l=e.val;null!=this.mouse.down&&(i=Math.min(this.mouse.down.ts,this.mouse.position.ts),s=(o=Math.max(this.mouse.down.ts,this.mouse.position.ts))-i,l="Zoom To:");var h='<div class="graph-tooltip-time">'+l+"</div>";h+="<center>",h+=this.dashboard.formatDate((0,r.default)(i))+"<br/>",h+="to<br/>",h+=this.dashboard.formatDate((0,r.default)(o))+"<br/><br/>",h+=r.default.duration(s).humanize()+"<br/>",h+="</center>";var u=0,d=0;if(n){var p=this.canvas.getBoundingClientRect();if((d=p.top+t.pos.panelRelY*p.height)<0||d>(0,a.default)(window).innerHeight())return void this.$tooltip.detach();d+=(0,a.default)(window).scrollTop();var c=this.range.to-this.range.from,f=(t.pos.x-this.range.from)/c;u=p.left+f*p.width}else u=t.evt.pageX,d=t.evt.pageY;this.$tooltip.html(h).place_tt(u+20,d+5)},e.prototype.onGraphHover=function(t,e,n){if(this.externalPT=!1,this.data&&this.data.length){var i=null,o=Math.floor(this.mouse.position.y/this.panel.rowHeight);if(o<0&&(o=0),o>=this.data.length&&(o=this.data.length-1),this.isTimeline){i=this.data[o].changes[0];for(var a=0;a<this.data[o].changes.length&&!(this.data[o].changes[a].start>this.mouse.position.ts);a++)i=this.data[o].changes[a];if(this.hoverPoint=i,this.annotations&&!n&&this._renderDimensions&&t.pos.y>this._renderDimensions.rowsHeight-5){var r=s.default.isUndefined(this.range.from)?null:this.range.from.valueOf(),l=s.default.isUndefined(this.range.to)?null:this.range.to.valueOf(),h=this._renderDimensions.width,u=s.default.find(this.annotations,function(e){if(e.isRegion)return t.pos.x>e.time&&t.pos.x<e.timeEnd;var n=(e.time-r)/(l-r)*h,i=t.evt.offsetX;return n>i-5&&n<i+5});if(u)return console.log("TODO, hover <annotation-tooltip>",u),void this.$tooltip.html(u.text).place_tt(t.evt.pageX+20,t.evt.pageY+5)}e&&(this.externalPT=n,this.showTooltip(t,i,n)),this.onRender()}else n||this.isStacked&&(i=this.data[o].legendInfo[0],this.hoverPoint=i,this.onRender(),e&&(this.externalPT=n,this.showLegandTooltip(t.evt,i)))}else this.$tooltip.detach()},e.prototype.onMouseClicked=function(t,e){if(1!=e.metaKey&&1!=e.ctrlKey){var n=this.hoverPoint;if(n&&n.start){var i={from:r.default.utc(n.start),to:r.default.utc(n.start+n.ms)};this.timeSrv.setTime(i),this.clear()}}else console.log("TODO? Create Annotation?",t,e)},e.prototype.onMouseSelectedRange=function(t,e){1!=e.metaKey&&1!=e.ctrlKey?(this.timeSrv.setTime(t),this.clear()):console.log("TODO? Create range annotation?",t,e)},e.prototype.clear=function(){this.mouse.position=null,this.mouse.down=null,this.hoverPoint=null,(0,a.default)(this.canvas).css("cursor","wait"),h.default.emit("graph-hover-clear"),this.render()},e.prototype._updateRenderDimensions=function(){var t=this;this._renderDimensions={};var e=this._renderDimensions.rect=this.wrap.getBoundingClientRect(),n=this._renderDimensions.rows=this.data.length,i=this._renderDimensions.rowHeight=this.panel.rowHeight,o=this._renderDimensions.rowsHeight=i*n,a=this.panel.showTimeAxis?14+this.panel.textSizeTime:0,r=this._renderDimensions.height=o+a,l=this._renderDimensions.width=e.width;this._renderDimensions.height=r;var h=0,u=this.range.to-this.range.from;this._renderDimensions.matrix=[],s.default.forEach(this.data,function(e){var n=[];if(t.isTimeline)for(var o=e.changes[0],s=0;s<e.changes.length;s++)if((o=e.changes[s]).start<=t.range.to){var a=Math.max(o.start-t.range.from,0)/u*l;n.push(a)}if(t.isStacked){o=null;var r=t.range.from;for(s=0;s<e.legendInfo.length;s++)o=e.legendInfo[s],a=Math.max(r-t.range.from,0)/u*l,n.push(a),r+=o.ms}t._renderDimensions.matrix.push({y:h,positions:n}),h+=i})},e.prototype._updateSelectionMatrix=function(){var t={all:function(){return!0},crosshairHover:function(t,e){return e+1===this.data[t].changes.length?this.data[t].changes[e].start<=this.mouse.position.ts:this.data[t].changes[e].start<=this.mouse.position.ts&&this.mouse.position.ts<this.data[t].changes[e+1].start},mouseX:function(t,e){var n=this._renderDimensions.matrix[t];return e+1===n.positions.length?n.positions[e]<=this.mouse.position.x:n.positions[e]<=this.mouse.position.x&&this.mouse.position.x<n.positions[e+1]},metric:function(t){return this.data[t]===this._selectedMetric},legendItem:function(t,e){return this.data[t]===this._selectedMetric&&this._selectedLegendItem.val===this._getVal(t,e)}}[function(){if(void 0!==this._selectedLegendItem)return"legendItem";if(void 0!==this._selectedMetric)return"metric";if(null!==this.mouse.down)return"all";if(this.panel.highlightOnMouseover&&null!=this.mouse.position){if(this.isTimeline)return"crosshairHover";if(this.isStacked)return"mouseX"}return"all"}.bind(this)()].bind(this);this._selectionMatrix=[];for(var e=0;e<this._renderDimensions.matrix.length;e++){for(var n=[],i=this._renderDimensions.matrix[e],o=0;o<i.positions.length;o++)n.push(t(e,o));this._selectionMatrix.push(n)}},e.prototype._updateCanvasSize=function(){this.canvas.width=this._renderDimensions.width*this._devicePixelRatio,this.canvas.height=this._renderDimensions.height*this._devicePixelRatio,(0,a.default)(this.canvas).css("width",this._renderDimensions.width+"px"),(0,a.default)(this.canvas).css("height",this._renderDimensions.height+"px"),this.context.scale(this._devicePixelRatio,this._devicePixelRatio)},e.prototype._getVal=function(t,e){var n=void 0;return this.isTimeline&&(n=this.data[t].changes[e]),this.isStacked&&(n=this.data[t].legendInfo[e]),n.val},e.prototype._renderRects=function(){var t=this,e=this._renderDimensions.matrix,n=this.context;s.default.forEach(this.data,function(i,o){for(var s=e[o],a=0;a<s.positions.length;a++){var r=s.positions[a],l=t._renderDimensions.width;a+1!==s.positions.length&&(l=s.positions[a+1]),n.fillStyle=t.getColor(t._getVal(o,a));var h=n.globalAlpha;t._selectionMatrix[o][a]||(n.globalAlpha=.3),n.fillRect(r,e[o].y,l-r,t._renderDimensions.rowHeight),n.globalAlpha=h}if(o>0){var u=e[o].y;n.strokeStyle=t.panel.lineColor,n.beginPath(),n.moveTo(0,u),n.lineTo(t._renderDimensions.width,u),n.stroke()}})},e.prototype._renderLabels=function(){var t=this,e=this.context;e.lineWidth=1,e.textBaseline="middle",e.font=this.panel.textSize+'px "Open Sans", Helvetica, Arial, sans-serif';var n=this._renderDimensions.rowHeight;s.default.forEach(this.data,function(i,o){var s=t._renderDimensions.matrix[o],a=s.y,r=s.positions,l=a+n/2,h=l,u=l,d=l,p=-1,c=-1;if(t.mouse.position)for(var f=0;f<r.length;f++)if(r[f]<=t.mouse.position.x&&(f>=r.length-1||r[f+1]>=t.mouse.position.x)){var m=t._getVal(o,f);e.fillStyle=t.panel.valueTextColor,e.textAlign="left",p=r[f]+2,e.fillText(m,p,d),c=p+(x=e.measureText(m)).width+4;break}var g=0,v=t._renderDimensions.width;if(t.panel.writeMetricNames){e.fillStyle=t.panel.metricNameColor,e.textAlign="left";var x=e.measureText(i.name);(p<0||p>x.width)&&(e.fillText(i.name,2,h),g=2+e.measureText(i.name).width+2)}if(t.panel.writeLastValue&&(m=t._getVal(o,r.length-1),e.fillStyle=t.panel.valueTextColor,e.textAlign="right",x=e.measureText(m),t._renderDimensions.width-2-x.width>c&&(e.fillText(m,t._renderDimensions.width-2,u),v=t._renderDimensions.width-e.measureText(m).width-10)),t.panel.writeAllValues)for(e.fillStyle=t.panel.valueTextColor,e.textAlign="left",f=0;f<r.length;f++){m=t._getVal(o,f);var y=t._renderDimensions.width;f+1!==r.length&&(y=r[f+1]);var _=r[f];if(_>g){var w=y-_;v>_+w&&(e.save(),e.rect(_,a,w,n),e.clip(),e.fillText(m,_+2,d),e.restore())}}})},e.prototype._renderSelection=function(){if(null!==this.mouse.down&&null!==this.mouse.position&&this.isTimeline){var t=this.context,e=this._renderDimensions.height,n=Math.min(this.mouse.position.x,this.mouse.down.x),i=Math.max(this.mouse.position.x,this.mouse.down.x);t.fillStyle="rgba(110, 110, 110, 0.5)",t.strokeStyle="rgba(110, 110, 110, 0.5)",t.beginPath(),t.fillRect(n,0,i-n,e),t.strokeRect(n,0,i-n,e)}},e.prototype._renderTimeAxis=function(){if(this.panel.showTimeAxis){var t=this.context,e=this._renderDimensions.width,n=this._renderDimensions.rowsHeight;t.font=this.panel.textSizeTime+'px "Open Sans", Helvetica, Arial, sans-serif',t.fillStyle=this.panel.timeTextColor,t.textAlign="left",t.strokeStyle=this.panel.timeTextColor,t.textBaseline="top",t.setLineDash([7,5]),t.lineDashOffset=0;var i=s.default.isUndefined(this.range.from)?null:this.range.from.valueOf(),o=s.default.isUndefined(this.range.to)?null:this.range.to.valueOf(),a=(o-i)/(e/(2*t.measureText("12/33 24:59").width)),r=this.getTimeResolution(a),l=r/(o-i)*e,h=this.roundDate(i,r)+r,u=0+(h-i)/(o-i)*e,d=this.time_format(o-i,r/1e3),p=0;for("utc"==this.dashboard.timezone&&(p=6e4*(new Date).getTimezoneOffset());h<o;){t.beginPath(),t.moveTo(u,n+5),t.lineTo(u,0),t.lineWidth=1,t.stroke();var c=new Date(h+p),f=this.formatDate(c,d),m=t.measureText(f).width/2;t.fillText(f,u-m,n+10),h+=r,u+=l}}},e.prototype._renderCrosshair=function(){if(null==this.mouse.down&&null!==this.mouse.position&&this.isTimeline){var t=this.context,e=this.data.length,n=this._renderDimensions.height;t.beginPath(),t.moveTo(this.mouse.position.x,0),t.lineTo(this.mouse.position.x,n),t.strokeStyle=this.panel.crosshairColor,t.setLineDash([]),t.lineWidth=1,t.stroke(),this.externalPT&&e>1&&(t.beginPath(),t.arc(this.mouse.position.x,this.mouse.position.y,3,0,2*Math.PI,!1),t.fillStyle=this.panel.crosshairColor,t.fill(),t.lineWidth=1)}},e.prototype._renderAnnotations=function(){var t=this;if(this.panel.showTimeAxis&&this.annotations){var e=this.context,n=this.panel.rowHeight,i=this._renderDimensions.width,o=this._renderDimensions.rowsHeight;e.font=this.panel.textSizeTime+'px "Open Sans", Helvetica, Arial, sans-serif',e.fillStyle="#7FE9FF",e.textAlign="left",e.strokeStyle="#7FE9FF",e.textBaseline="top",e.setLineDash([3,3]),e.lineDashOffset=0,e.lineWidth=2;var a=s.default.isUndefined(this.range.from)?null:this.range.from.valueOf(),r=s.default.isUndefined(this.range.to)?null:this.range.to.valueOf();s.default.forEach(this.annotations,function(s){e.setLineDash([3,3]);var l=!1;if(s.source.iconColor?(e.fillStyle=s.source.iconColor,e.strokeStyle=s.source.iconColor):void 0===s.annotation?(e.fillStyle="#7FE9FF",e.strokeStyle="#7FE9FF"):(l=!0,e.fillStyle="#EA0F3B",e.strokeStyle="#EA0F3B"),t._drawVertical(e,s.time,a,r,0,o,i,l),s.isRegion){t._drawVertical(e,s.timeEnd,a,r,0,o,i,l);var h=0+(s.time-a)/(r-a)*i,u=0+(s.timeEnd-a)/(r-a)*i;e.beginPath(),e.moveTo(h,o+5),e.lineTo(u,o+5),e.lineWidth=4,e.setLineDash([]),e.stroke(),0==l&&(e.save(),e.fillStyle="#7FE9FF",e.globalAlpha=.2,e.fillRect(h,0,u-h,n),e.stroke(),e.restore())}})}},e.prototype._drawVertical=function(t,e,n,i,o,s,a,r){var l=o+(e-n)/(i-n)*a;if(t.lineWidth=1,t.beginPath(),t.moveTo(l,s+5),t.lineTo(l,0),t.stroke(),t.moveTo(l+0,s),t.lineTo(l-5,s+7),t.lineTo(l+5,s+7),t.fill(),1==r){var h=t.measureText("▲").width/2;t.fillText("▲",l-h,s+10)}},e.templateUrl="partials/module.html",e.scrollable=!0,e}(i.CanvasPanelCtrl);e.PanelCtrl=c},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.CanvasPanelCtrl=void 0;var i=n(6),o=r(n(0)),s=r(n(1)),a=r(n(2));function r(t){return t&&t.__esModule?t:{default:t}}var l=function(){var t=function(e,n){return(t=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var n in e)e.hasOwnProperty(n)&&(t[n]=e[n])})(e,n)};return function(e,n){function i(){this.constructor=e}t(e,n),e.prototype=null===n?Object.create(n):(i.prototype=n.prototype,new i)}}(),h=function(t){function e(e,n){var i=t.call(this,e,n)||this;return i.data=null,i.mouse={position:null,down:null},i.$tooltip=(0,s.default)('<div class="graph-tooltip">'),i.events.on("panel-initialized",i.onPanelInitalized.bind(i)),i.events.on("refresh",i.onRefresh.bind(i)),i.events.on("render",i.onRender.bind(i)),i._devicePixelRatio=1,void 0!==window.devicePixelRatio&&(i._devicePixelRatio=window.devicePixelRatio),i}return l(e,t),e.$inject=["$scope","$injector"],e.prototype.onPanelInitalized=function(){this.render()},e.prototype.onRefresh=function(){this.render()},e.prototype.onRender=function(){if(this.context){console.log("canvas render",this.mouse);var t=this.wrap.getBoundingClientRect(),e=Math.max(this.height,100),n=t.width;this.canvas.width=n,this.canvas.height=e;var i=e/2,s=this.context;s.lineWidth=1,s.textBaseline="middle";var a="";if(null!=this.mouse.position&&(a=this.dashboard.formatDate((0,o.default)(this.mouse.position.ts))),s.fillStyle="#999999",s.fillRect(0,0,n,e),s.fillStyle="#111111",s.font='24px "Open Sans", Helvetica, Arial, sans-serif',s.textAlign="left",s.fillText("Mouse @ "+a,10,i),null!=this.mouse.position)if(null!=this.mouse.down){var r=Math.min(this.mouse.position.x,this.mouse.down.x),l=Math.max(this.mouse.position.x,this.mouse.down.x);s.globalCompositeOperation="destination-out",s.fillStyle="rgba(255, 255, 255, 0.6)",s.beginPath(),s.fillRect(0,0,r,e),s.fill(),s.beginPath(),s.fillRect(l,0,n,e),s.fill(),s.globalCompositeOperation="source-over"}else s.strokeStyle="#111",s.beginPath(),s.moveTo(this.mouse.position.x,0),s.lineTo(this.mouse.position.x,e),s.lineWidth=3,s.stroke(),s.beginPath(),s.moveTo(this.mouse.position.x,0),s.lineTo(this.mouse.position.x,e),s.strokeStyle="#e22c14",s.lineWidth=2,s.stroke()}else console.log("No context!")},e.prototype.clearTT=function(){this.$tooltip.detach()},e.prototype.getMousePosition=function(t){var e=this.range.to-this.range.from,n=this.canvas.getBoundingClientRect(),i=t.offsetX,o=this.range.from+e*(i/parseFloat(n.width)),s=t.clientY-n.top;return{x:i,y:s,yRel:s/parseFloat(n.height),ts:o,evt:t}},e.prototype.onGraphHover=function(t,e,n){console.log("HOVER",t,e,n)},e.prototype.onMouseClicked=function(t,e){console.log("CANVAS CLICKED",t,e),this.render()},e.prototype.onMouseSelectedRange=function(t,e){console.log("CANVAS Range",t,e)},e.prototype.link=function(t,e,n,i){var o=this;this.wrap=e.find(".canvas-spot")[0],this.canvas=document.createElement("canvas"),this.wrap.appendChild(this.canvas),(0,s.default)(this.canvas).css("cursor","pointer"),(0,s.default)(this.wrap).css("width","100%"),this.context=this.canvas.getContext("2d"),this.canvas.addEventListener("mousemove",function(t){if(o.range){o.mouse.position=o.getMousePosition(t);var e={pos:{pageX:t.pageX,pageY:t.pageY,x:o.mouse.position.ts,y:o.mouse.position.y,panelRelY:o.mouse.position.yRel,panelRelX:o.mouse.position.xRel},evt:t,panel:o.panel};a.default.emit("graph-hover",e),null!=o.mouse.down&&(0,s.default)(o.canvas).css("cursor","col-resize")}},!1),this.canvas.addEventListener("mouseout",function(t){null==o.mouse.down&&(o.mouse.position=null,o.onRender(),o.$tooltip.detach(),a.default.emit("graph-hover-clear"))},!1),this.canvas.addEventListener("mousedown",function(t){},!1),this.canvas.addEventListener("mouseenter",function(t){o.mouse.down&&!t.buttons&&(o.mouse.position=null,o.mouse.down=null,o.onRender(),o.$tooltip.detach(),a.default.emit("graph-hover-clear")),(0,s.default)(o.canvas).css("cursor","pointer")},!1),this.canvas.addEventListener("mouseup",function(t){},!1),this.canvas.addEventListener("dblclick",function(t){o.mouse.position=null,o.mouse.down=null,o.onRender(),o.$tooltip.detach(),a.default.emit("graph-hover-clear"),console.log("TODO, ZOOM OUT")},!0),a.default.on("graph-hover",function(t){var e=t.panel.id===o.panel.id;if((o.dashboard.sharedTooltipModeEnabled()||e)&&!o.otherPanelInFullscreenMode()){if(!e){if(!t.pos.x||!o.range)return;var n=t.pos.x,i=o.canvas.getBoundingClientRect(),s=o.range.to-o.range.from,a=(n-o.range.from)/s*i.width;o.mouse.position={x:a,y:t.pos.panelRelY*i.height,yRel:t.pos.panelRelY,ts:n,gevt:t}}o.onGraphHover(t,e||!o.dashboard.sharedCrosshairModeOnly(),!e)}},t),a.default.on("graph-hover-clear",function(t,e){o.mouse.position=null,o.mouse.down=null,o.render(),o.$tooltip.detach()},t)},e.prototype.time_format=function(t,e){return e<=45?"%H:%M:%S":e<=7200||t<=864e5?"%H:%M":e<=8e4?"%m/%d %H:%M":e<=2419200||t<=31536e6?"%m/%d":"%Y-%m"},e.prototype.getTimeResolution=function(t){var e=t/1e3;return e<=30?3e4:e<=60?6e4:e<=300?3e5:e<=600?6e5:e<=1800?18e5:e<=3600?36e5:e<=3600?36e5:e<=7200?72e5:e<=21600?216e5:e<=43200?432e5:e<=86400?864e5:e<=172800?1728e5:e<=604800?6048e5:e<=2592e3?2592e6:15552e6},e.prototype.roundDate=function(t,e){return t-t%e},e.prototype.formatDate=function(t,e){var n=["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"],i=["Sun","Mon","Tue","Wed","Thu","Fri","Sat"];if("function"==typeof t.strftime)return t.strftime(e);var o,s=[],a=!1,r=t.getHours(),l=r<12;o=r>12?r-12:0==r?12:r;for(var h=0;h<e.length;++h){var u=e.charAt(h);if(a){switch(u){case"a":u=""+i[t.getDay()];break;case"b":u=""+n[t.getMonth()];break;case"d":u=this.leftPad(t.getDate(),"");break;case"e":u=this.leftPad(t.getDate()," ");break;case"h":case"H":u=this.leftPad(r,null);break;case"I":u=this.leftPad(o,null);break;case"l":u=this.leftPad(o," ");break;case"m":u=this.leftPad(t.getMonth()+1,"");break;case"M":u=this.leftPad(t.getMinutes(),null);break;case"q":u=""+(Math.floor(t.getMonth()/3)+1);break;case"S":u=this.leftPad(t.getSeconds(),null);break;case"y":u=this.leftPad(t.getFullYear()%100,null);break;case"Y":u=""+t.getFullYear();break;case"p":u=l?"am":"pm";break;case"P":u=l?"AM":"PM";break;case"w":u=""+t.getDay()}s.push(u),a=!1}else"%"==u?a=!0:s.push(u)}return s.join("")},e.prototype.leftPad=function(t,e){return t=""+t,e=""+(null==e?"0":e),1==t.length?e+t:t},e}(i.MetricsPanelCtrl);e.CanvasPanelCtrl=h},function(t,e){t.exports=o},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0}),e.DistinctPoints=e.LegendValue=e.PointInfo=void 0;var i=function(t){return t&&t.__esModule?t:{default:t}}(n(3)),o=function(t,e){this.ms=0,this.val=t,this.start=e};e.PointInfo=o;var s=function(t){this.ms=0,this.count=0,this.per=0,this.val=t};e.LegendValue=s;var a=function(){function t(t){this.name=t,this.changes=[],this.legendInfo=[],this.last=null,this.asc=!1,this.transitionCount=0,this.distinctValuesCount=0,this.elapsed=0}return t.prototype.add=function(t,e){if(null==this.last)this.last={val:e,start:t,ms:0},this.changes.push(this.last);else{if(t===this.last.start)return void console.log("skip point with duplicate timestamp",t,e);if(1===this.changes.length&&(this.asc=t>this.last.start),t>this.last.start!==this.asc)return void console.log("skip out of order point",t,e);e===this.last.val?this.asc||(this.last.start=t):(this.last={val:e,start:t,ms:0},this.changes.push(this.last))}},t.prototype.finish=function(t){var e=this;if(this.changes.length<1)console.log("no points found!");else{if(this.asc||(this.last=this.changes[0],i.default.reverse(this.changes)),this.last.start<t.range.to){var n=t.range.to+1;this.changes.push({val:this.last.val,start:n,ms:0})}this.transitionCount=0;for(var o=new Map,s=this.changes[0],a=1;a<this.changes.length;a++){var r=this.changes[a],l=s.start,h=r.start;if(l<t.range.from?l=t.range.from:l<t.range.to&&this.transitionCount++,h>t.range.to&&(h=t.range.to),s.ms=h-l,s.ms>0)if(o.has(s.val)){var u=o.get(s.val);u.ms+=s.ms,u.count++}else o.set(s.val,{val:s.val,ms:s.ms,count:1,per:0});s=r}var d=t.range.to-t.range.from;this.elapsed=d,o.forEach(function(t,n){t.per=t.ms/d,e.legendInfo.push(t)}),this.distinctValuesCount=i.default.size(this.legendInfo),t.isTimeline||(this.legendInfo=i.default.orderBy(this.legendInfo,["ms"],["desc"]))}},t.combineLegend=function(e,n){if(1==e.length)return e[0];var o=new t("merged"),s=0,a=new Map;return i.default.forEach(e,function(t){o.transitionCount+=t.transitionCount,s+=t.elapsed,i.default.forEach(t.legendInfo,function(t){if(a.has(t.val)){var e=a.get(t.val);e.ms+=t.ms,e.count+=t.count}else a.set(t.val,{val:t.val,ms:t.ms,count:t.count,per:0})})}),o.elapsed=s,a.forEach(function(t,e){t.per=t.ms/s,o.legendInfo.push(t)}),o.distinctValuesCount=i.default.size(o.legendInfo),o},t}();e.DistinctPoints=a},function(t,e){t.exports=s}])});
//# sourceMappingURL=module.js.map